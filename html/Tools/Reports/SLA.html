<& /Elements/Header, Title => $title &>
<& /Elements/Tabs &>

<&| /Widgets/TitleBox, title => loc('Summary') &>
<form method="post" action="SLA.html">
<table>
    <tr>
        <td class="label"><&|/l&>Query</&>:</td>
        <td class="value"><textarea cols="60" rows="20" name="Query"><% $Query %></textarea></td>
    </tr>
</table>

<& /Elements/Submit, Label => loc('Update') &>
</form>
</&>

% if ( $summary ) {
<&| /Widgets/TitleBox, title => loc('Summary') &>
<& /Elements/SLA/ShowReportSummary, Summary => $summary &>
</&>
% }

<%ARGS>
$Query => undef
</%ARGS>
<%INIT>
unless (
    $session{'CurrentUser'}->PrincipalObj->HasRight(
        Object => $RT::System, Right => 'SeeSLAReports',
    )
) {
    Abort("You're not allowed to see SLA reports.");
}

my $title = loc("Report on Service Level Agreements");

my $summary;
if ( $Query ) {
    $summary = new RT::Extension::SLA::Summary;

    my $tickets = RT::Tickets->new( $session{'CurrentUser'} );
    $tickets->FromSQL( $Query );
    $tickets->OrderByCols( {FIELD => 'id', ORDER => 'ASC'} );
    while ( my $ticket = $tickets->Next ) {
        $summary->AddReport( RT::Extension::SLA->TicketReport( $ticket ) );
    }
    $summary->Finalize;
}
</%INIT>
